<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>BPMN Modeler</title>
    <link rel="stylesheet" href="styles.css">
</head>
<body>
    <div class="app-container">
        <header>
            <h1>BPMN Modeler</h1>
            <div class="theme-selector">
                <label for="themeSelect">Theme:</label>
                <select id="themeSelect">
                    <optgroup label="Modern Themes">
                        <option value="blue" class="theme-option-blue">üîµ Blue</option>
                        <option value="orange" class="theme-option-orange">üü† Orange</option>
                        <option value="green" class="theme-option-green">üü¢ Green</option>
                        <option value="lavender" class="theme-option-lavender">üü£ Lavender</option>
                        <option value="teal" class="theme-option-teal">üî∑ Teal</option>
                        <option value="pink" class="theme-option-pink">üå∏ Pink</option>
                    </optgroup>
                    <optgroup label="Pantone Color of the Year">
                        <option value="viva-magenta">üíó Viva Magenta (2023)</option>
                        <option value="very-peri">üíú Very Peri (2022)</option>
                        <option value="illuminating">üíõ Illuminating (2021)</option>
                        <option value="classic-blue">üî∑ Classic Blue (2020)</option>
                        <option value="living-coral">ü™∏ Living Coral (2019)</option>
                        <option value="ultra-violet">üíú Ultra Violet (2018)</option>
                        <option value="greenery">üåø Greenery (2017)</option>
                        <option value="rose-quartz">üå∏ Rose Quartz (2016)</option>
                        <option value="marsala">üç∑ Marsala (2015)</option>
                        <option value="radiant-orchid">üå∫ Radiant Orchid (2014)</option>
                        <option value="emerald">üíé Emerald (2013)</option>
                        <option value="tangerine-tango">üçä Tangerine Tango (2012)</option>
                    </optgroup>
                    <optgroup label="Pantone Featured Colors">
                        <option value="cloud-dancer">‚òÅÔ∏è Cloud Dancer</option>
                    </optgroup>
                </select>
            </div>
            <div class="toolbar">
                <button id="newBtn" class="btn">New</button>
                <button id="saveBtn" class="btn">Export YAML</button>
                <button id="loadBtn" class="btn">Import YAML</button>
                <input type="file" id="fileInput" accept=".yaml,.yml" style="display: none;">
                <button id="executeBtn" class="btn execute-workflow-btn">‚ñ∂ Execute Workflow</button>
                <button id="simulateBtn" class="btn" style="background-color: #9b59b6; color: white;">üé¨ Simulate</button>

                <!-- Simulation Controls (hidden by default, shown during simulation) -->
                <div id="simulationToolbarControls" style="display: none; margin-left: 0.5rem; padding: 0.3rem 0.8rem; background: #f0f0f0; border-radius: 4px; border: 2px solid #9b59b6;">
                    <span style="font-size: 0.85rem; font-weight: bold; color: #9b59b6; margin-right: 0.5rem;">üé¨ Simulation:</span>
                    <button id="pauseSimToolbarBtn" class="btn-small">‚è∏Ô∏è Pause</button>
                    <button id="resumeSimToolbarBtn" class="btn-small" style="display: none;">‚ñ∂Ô∏è Resume</button>
                    <button id="stopSimToolbarBtn" class="btn-small" style="background-color: #e74c3c; color: white;">‚èπÔ∏è Stop</button>
                    <select id="simSpeedToolbar" style="margin-left: 0.5rem; padding: 0.3rem 0.5rem; border: 1px solid #ccc; border-radius: 3px; font-size: 0.85rem;">
                        <option value="0.5">0.5x</option>
                        <option value="1" selected>1x</option>
                        <option value="2">2x</option>
                        <option value="5">5x</option>
                        <option value="10">10x</option>
                    </select>
                </div>

                <button id="clearExecutionBtn" class="btn" style="background-color: #95a5a6; color: white;">Clear Execution</button>
            </div>
        </header>

        <div class="main-content">
            <aside class="palette">
                <h3>Elements</h3>
                <div class="palette-section">
                    <h4>Events</h4>
                    <div class="palette-section-items">
                    <div class="palette-item" data-type="startEvent" title="Start Event - Triggers the beginning of a workflow process">
                        <svg width="40" height="40">
                            <circle cx="20" cy="20" r="15" fill="white" stroke="#000" stroke-width="2"/>
                        </svg>
                        <span>Start</span>
                    </div>
                    <div class="palette-item" data-type="endEvent" title="End Event - Marks the completion of a workflow process">
                        <svg width="40" height="40">
                            <circle cx="20" cy="20" r="15" fill="white" stroke="#000" stroke-width="4"/>
                        </svg>
                        <span>End</span>
                    </div>
                    <div class="palette-item" data-type="intermediateEvent" title="Intermediate Event - Occurs between start and end, can catch or throw events">
                        <svg width="40" height="40">
                            <circle cx="20" cy="20" r="15" fill="white" stroke="#000" stroke-width="2"/>
                            <circle cx="20" cy="20" r="12" fill="none" stroke="#000" stroke-width="2"/>
                        </svg>
                        <span>Intermediate</span>
                    </div>
                    <div class="palette-item" data-type="timerIntermediateCatchEvent" title="Timer Event - Waits for a specific time or duration before continuing">
                        <svg width="40" height="40">
                            <circle cx="20" cy="20" r="15" fill="white" stroke="#000" stroke-width="2"/>
                            <circle cx="20" cy="20" r="12" fill="none" stroke="#000" stroke-width="2"/>
                            <!-- Timer clock icon -->
                            <circle cx="20" cy="20" r="8" fill="none" stroke="#000" stroke-width="1"/>
                            <line x1="20" y1="20" x2="20" y2="15" stroke="#000" stroke-width="1.5"/>
                            <line x1="20" y1="20" x2="24" y2="20" stroke="#000" stroke-width="1.5"/>
                        </svg>
                        <span>Timer</span>
                    </div>
                    <div class="palette-item" data-type="boundaryTimerEvent" title="Boundary Timer - Attaches to a task, triggers timeout or deadline handling">
                        <svg width="40" height="40">
                            <circle cx="20" cy="20" r="12" fill="white" stroke="#000" stroke-width="2"/>
                            <circle cx="20" cy="20" r="9" fill="none" stroke="#000" stroke-width="2"/>
                            <!-- Timer clock icon (smaller) -->
                            <circle cx="20" cy="20" r="6" fill="none" stroke="#000" stroke-width="1"/>
                            <line x1="20" y1="20" x2="20" y2="16" stroke="#000" stroke-width="1"/>
                            <line x1="20" y1="20" x2="23" y2="20" stroke="#000" stroke-width="1"/>
                        </svg>
                        <span>Boundary Timer</span>
                    </div>
                    </div>
                </div>

                <div class="palette-section">
                    <h4>Activities</h4>
                    <div class="palette-section-items">
                    <div class="palette-item" data-type="task" title="Task - Generic work unit that needs to be performed">
                        <svg width="40" height="40">
                            <rect x="5" y="10" width="30" height="20" rx="5" fill="white" stroke="#000" stroke-width="2"/>
                        </svg>
                        <span>Task</span>
                    </div>
                    <div class="palette-item" data-type="userTask" title="User Task - Work performed by a human user via a form or interface">
                        <svg width="40" height="40">
                            <rect x="5" y="10" width="30" height="20" rx="5" fill="white" stroke="#000" stroke-width="2"/>
                            <circle cx="11" cy="17" r="2" fill="none" stroke="#000" stroke-width="1"/>
                            <path d="M 8 24 Q 11 21 14 24" fill="none" stroke="#000" stroke-width="1"/>
                        </svg>
                        <span>User Task</span>
                    </div>
                    <div class="palette-item" data-type="serviceTask" title="Service Task - Automated work performed by an external system or API">
                        <svg width="40" height="40">
                            <rect x="5" y="10" width="30" height="20" rx="5" fill="white" stroke="#000" stroke-width="2"/>
                            <circle cx="11" cy="20" r="3" fill="none" stroke="#000" stroke-width="1"/>
                            <line x1="11" y1="17" x2="11" y2="14" stroke="#000" stroke-width="1"/>
                            <line x1="11" y1="23" x2="11" y2="26" stroke="#000" stroke-width="1"/>
                            <line x1="8" y1="20" x2="5" y2="20" stroke="#000" stroke-width="1"/>
                            <line x1="14" y1="20" x2="17" y2="20" stroke="#000" stroke-width="1"/>
                        </svg>
                        <span>Service Task</span>
                    </div>
                    <div class="palette-item" data-type="scriptTask" title="Script Task - Executes a script or code snippet (Python, JavaScript, etc.)">
                        <svg width="40" height="40">
                            <rect x="5" y="10" width="30" height="20" rx="5" fill="white" stroke="#000" stroke-width="2"/>
                            <!-- Scroll icon -->
                            <rect x="8" y="16" width="8" height="7" fill="none" stroke="#000" stroke-width="1"/>
                            <path d="M 8 16 Q 12 15 16 16" fill="none" stroke="#000" stroke-width="1"/>
                            <path d="M 8 23 Q 12 24 16 23" fill="none" stroke="#000" stroke-width="1"/>
                            <line x1="9" y1="18" x2="15" y2="18" stroke="#000" stroke-width="0.7"/>
                            <line x1="9" y1="20" x2="15" y2="20" stroke="#000" stroke-width="0.7"/>
                            <line x1="9" y1="22" x2="15" y2="22" stroke="#000" stroke-width="0.7"/>
                        </svg>
                        <span>Script Task</span>
                    </div>
                    <div class="palette-item" data-type="sendTask" title="Send Task - Sends a message, email, or notification to external parties">
                        <svg width="40" height="40">
                            <rect x="5" y="10" width="30" height="20" rx="5" fill="white" stroke="#000" stroke-width="2"/>
                            <path d="M 7 18 L 7 23 L 15 23 L 15 18 Z" fill="#000" stroke="#000" stroke-width="1"/>
                            <path d="M 7 18 L 11 21 L 15 18" fill="#000" stroke="#000" stroke-width="1"/>
                        </svg>
                        <span>Send Task</span>
                    </div>
                    <div class="palette-item" data-type="receiveTask" title="Receive Task - Waits for an incoming message or signal before continuing">
                        <svg width="40" height="40">
                            <rect x="5" y="10" width="30" height="20" rx="5" fill="white" stroke="#000" stroke-width="2"/>
                            <path d="M 7 18 L 7 23 L 15 23 L 15 18 Z" fill="white" stroke="#000" stroke-width="1"/>
                            <path d="M 7 18 L 11 21 L 15 18" fill="white" stroke="#000" stroke-width="1"/>
                        </svg>
                        <span>Receive Task</span>
                    </div>
                    <div class="palette-item" data-type="manualTask" title="Manual Task - Physical work done by a person without system interaction">
                        <svg width="40" height="40">
                            <rect x="5" y="10" width="30" height="20" rx="5" fill="white" stroke="#000" stroke-width="2"/>
                            <path d="M 8 21 L 8 18 L 11 18 L 11 16 L 12 16 L 12 19 L 10 19 L 10 21 Z" fill="none" stroke="#000" stroke-width="1"/>
                        </svg>
                        <span>Manual Task</span>
                    </div>
                    <div class="palette-item" data-type="businessRuleTask" title="Business Rule Task - Evaluates business rules or decision tables">
                        <svg width="40" height="40">
                            <rect x="5" y="10" width="30" height="20" rx="5" fill="white" stroke="#000" stroke-width="2"/>
                            <rect x="8" y="17" width="8" height="6" fill="none" stroke="#000" stroke-width="1"/>
                            <line x1="8" y1="19" x2="16" y2="19" stroke="#000" stroke-width="1"/>
                            <line x1="10" y1="17" x2="10" y2="23" stroke="#000" stroke-width="1"/>
                        </svg>
                        <span>Business Rule</span>
                    </div>
                    <div class="palette-item" data-type="subProcess" title="Sub-Process - Container for a nested workflow with internal elements">
                        <svg width="40" height="40">
                            <rect x="5" y="10" width="30" height="20" rx="5" fill="white" stroke="#000" stroke-width="2"/>
                            <rect x="17" y="26" width="6" height="6" fill="none" stroke="#000" stroke-width="1"/>
                            <line x1="20" y1="26" x2="20" y2="32" stroke="#000" stroke-width="1"/>
                            <line x1="17" y1="29" x2="23" y2="29" stroke="#000" stroke-width="1"/>
                        </svg>
                        <span>Sub-Process</span>
                    </div>
                    <div class="palette-item" data-type="callActivity" title="Call Activity - Calls and executes another reusable workflow process">
                        <svg width="40" height="40">
                            <rect x="5" y="10" width="30" height="20" rx="5" fill="white" stroke="#000" stroke-width="4"/>
                        </svg>
                        <span>Call Activity</span>
                    </div>
                    </div>
                </div>

                <div class="palette-section">
                    <h4>Custom Tasks</h4>
                    <div class="palette-section-items">
                    <div class="palette-item" data-type="agenticTask" title="Agentic Task - AI/LLM-powered task using MCP tools for intelligent automation">
                        <svg width="40" height="40">
                            <rect x="5" y="10" width="30" height="20" rx="5" fill="white" stroke="#000" stroke-width="2"/>
                            <!-- Brain icon -->
                            <path d="M 10 15 C 9.5 14.5 9.5 14 10 13.5 C 10.5 13 11.5 13 12 13.5 C 12.3 13 12.7 13 13 13.5 C 13.5 13 14.5 13 15 13.5 C 15.5 14 15.5 14.5 15 15 C 15 15.5 15 16 14.5 16.5 C 14 17 13.5 17 13 16.5 C 12.7 17 12.3 17 12 16.5 C 11.5 17 11 17 10.5 16.5 C 10 16 10 15.5 10 15 Z" fill="none" stroke="#ec4899" stroke-width="1.2"/>
                            <path d="M 11 14.5 Q 11.5 15 11.5 15.5" fill="none" stroke="#ec4899" stroke-width="0.8"/>
                            <path d="M 12.5 14 Q 13 14.5 13 15" fill="none" stroke="#ec4899" stroke-width="0.8"/>
                            <path d="M 14 14.5 Q 14.5 15 14.5 15.5" fill="none" stroke="#ec4899" stroke-width="0.8"/>
                            <line x1="12.5" y1="13.5" x2="12.5" y2="16.5" stroke="#ec4899" stroke-width="0.6" stroke-dasharray="1,0.5"/>
                        </svg>
                        <span>Agentic Task</span>
                    </div>
                    </div>
                </div>

                <div class="palette-section">
                    <h4>Gateways</h4>
                    <div class="palette-section-items">
                    <div class="palette-item" data-type="exclusiveGateway" title="Exclusive Gateway (XOR) - Routes flow to ONE path based on conditions">
                        <svg width="40" height="40">
                            <path d="M 20 5 L 35 20 L 20 35 L 5 20 Z" fill="white" stroke="#000" stroke-width="2"/>
                            <text x="20" y="27" text-anchor="middle" font-size="20" font-weight="bold">√ó</text>
                        </svg>
                        <span>Exclusive</span>
                    </div>
                    <div class="palette-item" data-type="parallelGateway" title="Parallel Gateway (AND) - Splits flow to ALL paths simultaneously">
                        <svg width="40" height="40">
                            <path d="M 20 5 L 35 20 L 20 35 L 5 20 Z" fill="white" stroke="#000" stroke-width="2"/>
                            <text x="20" y="26" text-anchor="middle" font-size="20" font-weight="bold">+</text>
                        </svg>
                        <span>Parallel</span>
                    </div>
                    <div class="palette-item" data-type="inclusiveGateway" title="Inclusive Gateway (OR) - Routes to one or more paths, merges when first completes">
                        <svg width="40" height="40">
                            <path d="M 20 5 L 35 20 L 20 35 L 5 20 Z" fill="white" stroke="#000" stroke-width="2"/>
                            <circle cx="20" cy="20" r="8" fill="none" stroke="#000" stroke-width="2"/>
                        </svg>
                        <span>Inclusive</span>
                    </div>
                    </div>
                </div>

                <div class="palette-section">
                    <h4>Boundary Events (Interrupting)</h4>
                    <div class="palette-section-items">
                    <div class="palette-item" data-type="errorBoundaryEvent" data-interrupting="true" title="Error Boundary Event (Interrupting) - Catches exceptions and stops the task. Solid border = interrupting.">
                        <svg width="40" height="40">
                            <circle cx="20" cy="20" r="12" fill="white" stroke="#e74c3c" stroke-width="2"/>
                            <circle cx="20" cy="20" r="9" fill="none" stroke="#e74c3c" stroke-width="1.5"/>
                            <!-- Lightning bolt icon -->
                            <path d="M 22 13 L 17 20 L 20 20 L 18 27 L 23 20 L 20 20 Z" fill="#e74c3c" stroke="none"/>
                        </svg>
                        <span style="font-size: 0.7rem;">Error (I)</span>
                    </div>
                    <div class="palette-item" data-type="timerBoundaryEvent" data-interrupting="true" title="Timer Boundary Event (Interrupting) - Timeout stops the task. Solid border = interrupting.">
                        <svg width="40" height="40">
                            <circle cx="20" cy="20" r="12" fill="white" stroke="#f39c12" stroke-width="2"/>
                            <circle cx="20" cy="20" r="9" fill="none" stroke="#f39c12" stroke-width="1.5"/>
                            <!-- Clock icon -->
                            <circle cx="20" cy="20" r="6" fill="none" stroke="#f39c12" stroke-width="1.5"/>
                            <line x1="20" y1="20" x2="20" y2="16" stroke="#f39c12" stroke-width="1.5"/>
                            <line x1="20" y1="20" x2="23" y2="20" stroke="#f39c12" stroke-width="1.5"/>
                        </svg>
                        <span style="font-size: 0.7rem;">Timer (I)</span>
                    </div>
                    <div class="palette-item" data-type="escalationBoundaryEvent" data-interrupting="true" title="Escalation Boundary Event (Interrupting) - Escalates and stops task. Solid border = interrupting.">
                        <svg width="40" height="40">
                            <circle cx="20" cy="20" r="12" fill="white" stroke="#9b59b6" stroke-width="2"/>
                            <circle cx="20" cy="20" r="9" fill="none" stroke="#9b59b6" stroke-width="1.5"/>
                            <!-- Up arrow icon -->
                            <path d="M 20 15 L 16 21 L 18.5 21 L 18.5 25 L 21.5 25 L 21.5 21 L 24 21 Z" fill="#9b59b6" stroke="none"/>
                        </svg>
                        <span style="font-size: 0.7rem;">Escalate (I)</span>
                    </div>
                    <div class="palette-item" data-type="signalBoundaryEvent" data-interrupting="true" title="Signal Boundary Event (Interrupting) - Signal stops the task. Solid border = interrupting.">
                        <svg width="40" height="40">
                            <circle cx="20" cy="20" r="12" fill="white" stroke="#3498db" stroke-width="2"/>
                            <circle cx="20" cy="20" r="9" fill="none" stroke="#3498db" stroke-width="1.5"/>
                            <!-- Triangle (signal) icon -->
                            <path d="M 20 15 L 25 24 L 15 24 Z" fill="none" stroke="#3498db" stroke-width="1.5"/>
                        </svg>
                        <span style="font-size: 0.7rem;">Signal (I)</span>
                    </div>
                    <div class="palette-item" data-type="compensationBoundaryEvent" data-interrupting="true" title="Compensation Boundary Event (Interrupting) - Triggers compensation/rollback and stops task. Solid border = interrupting.">
                        <svg width="40" height="40">
                            <circle cx="20" cy="20" r="12" fill="white" stroke="#d35400" stroke-width="2"/>
                            <circle cx="20" cy="20" r="9" fill="none" stroke="#d35400" stroke-width="1.5"/>
                            <!-- Double backward arrows (compensation icon) -->
                            <path d="M 17 15 L 13 20 L 17 25" fill="none" stroke="#d35400" stroke-width="1.5"/>
                            <path d="M 24 15 L 20 20 L 24 25" fill="none" stroke="#d35400" stroke-width="1.5"/>
                        </svg>
                        <span style="font-size: 0.7rem;">Compensate (I)</span>
                    </div>
                    </div>
                </div>

                <div class="palette-section">
                    <h4>Boundary Events (Non-Interrupting)</h4>
                    <div class="palette-section-items">
                    <div class="palette-item" data-type="errorBoundaryEvent" data-interrupting="false" title="Error Boundary Event (Non-Interrupting) - Catches errors but task continues. Dashed border = non-interrupting.">
                        <svg width="40" height="40">
                            <circle cx="20" cy="20" r="12" fill="white" stroke="#e74c3c" stroke-width="2" stroke-dasharray="3,2"/>
                            <circle cx="20" cy="20" r="9" fill="none" stroke="#e74c3c" stroke-width="1.5" stroke-dasharray="2,1.5"/>
                            <!-- Lightning bolt icon -->
                            <path d="M 22 13 L 17 20 L 20 20 L 18 27 L 23 20 L 20 20 Z" fill="#e74c3c" stroke="none"/>
                        </svg>
                        <span style="font-size: 0.7rem;">Error (NI)</span>
                    </div>
                    <div class="palette-item" data-type="timerBoundaryEvent" data-interrupting="false" title="Timer Boundary Event (Non-Interrupting) - Triggers on timeout but task continues. Dashed border = non-interrupting.">
                        <svg width="40" height="40">
                            <circle cx="20" cy="20" r="12" fill="white" stroke="#f39c12" stroke-width="2" stroke-dasharray="3,2"/>
                            <circle cx="20" cy="20" r="9" fill="none" stroke="#f39c12" stroke-width="1.5" stroke-dasharray="2,1.5"/>
                            <!-- Clock icon -->
                            <circle cx="20" cy="20" r="6" fill="none" stroke="#f39c12" stroke-width="1.5"/>
                            <line x1="20" y1="20" x2="20" y2="16" stroke="#f39c12" stroke-width="1.5"/>
                            <line x1="20" y1="20" x2="23" y2="20" stroke="#f39c12" stroke-width="1.5"/>
                        </svg>
                        <span style="font-size: 0.7rem;">Timer (NI)</span>
                    </div>
                    <div class="palette-item" data-type="escalationBoundaryEvent" data-interrupting="false" title="Escalation Boundary Event (Non-Interrupting) - Escalates but task continues. Dashed border = non-interrupting.">
                        <svg width="40" height="40">
                            <circle cx="20" cy="20" r="12" fill="white" stroke="#9b59b6" stroke-width="2" stroke-dasharray="3,2"/>
                            <circle cx="20" cy="20" r="9" fill="none" stroke="#9b59b6" stroke-width="1.5" stroke-dasharray="2,1.5"/>
                            <!-- Up arrow icon -->
                            <path d="M 20 15 L 16 21 L 18.5 21 L 18.5 25 L 21.5 25 L 21.5 21 L 24 21 Z" fill="#9b59b6" stroke="none"/>
                        </svg>
                        <span style="font-size: 0.7rem;">Escalate (NI)</span>
                    </div>
                    <div class="palette-item" data-type="signalBoundaryEvent" data-interrupting="false" title="Signal Boundary Event (Non-Interrupting) - Catches signal but task continues. Dashed border = non-interrupting.">
                        <svg width="40" height="40">
                            <circle cx="20" cy="20" r="12" fill="white" stroke="#3498db" stroke-width="2" stroke-dasharray="3,2"/>
                            <circle cx="20" cy="20" r="9" fill="none" stroke="#3498db" stroke-width="1.5" stroke-dasharray="2,1.5"/>
                            <!-- Triangle (signal) icon -->
                            <path d="M 20 15 L 25 24 L 15 24 Z" fill="none" stroke="#3498db" stroke-width="1.5"/>
                        </svg>
                        <span style="font-size: 0.7rem;">Signal (NI)</span>
                    </div>
                    <div class="palette-item" data-type="compensationBoundaryEvent" data-interrupting="false" title="Compensation Boundary Event (Non-Interrupting) - Triggers compensation/rollback but task continues. Dashed border = non-interrupting.">
                        <svg width="40" height="40">
                            <circle cx="20" cy="20" r="12" fill="white" stroke="#d35400" stroke-width="2" stroke-dasharray="3,2"/>
                            <circle cx="20" cy="20" r="9" fill="none" stroke="#d35400" stroke-width="1.5" stroke-dasharray="2,1.5"/>
                            <!-- Double backward arrows (compensation icon) -->
                            <path d="M 17 15 L 13 20 L 17 25" fill="none" stroke="#d35400" stroke-width="1.5"/>
                            <path d="M 24 15 L 20 20 L 24 25" fill="none" stroke="#d35400" stroke-width="1.5"/>
                        </svg>
                        <span style="font-size: 0.7rem;">Compensate (NI)</span>
                    </div>
                    </div>
                </div>

                <div class="palette-section">
                    <h4>Swimlanes</h4>
                    <div class="palette-section-items">
                    <div class="palette-item" data-type="pool" title="Pool - Container representing a participant or organization in the workflow">
                        <svg width="40" height="40">
                            <rect x="5" y="10" width="30" height="20" fill="#e8f4f8" stroke="#000" stroke-width="2"/>
                        </svg>
                        <span>Pool</span>
                    </div>
                    <div class="palette-item" data-type="lane" title="Lane - Sub-division within a pool representing roles or departments">
                        <svg width="40" height="40">
                            <rect x="5" y="10" width="30" height="20" fill="#f0f8ff" stroke="#000" stroke-width="1"/>
                        </svg>
                        <span>Lane</span>
                    </div>
                    </div>
                </div>

                <div class="palette-section">
                    <h4>Connections</h4>
                    <div class="palette-section-items">
                    <div class="palette-item" data-type="sequenceFlow" title="Sequence Flow - Connects elements showing the order of execution">
                        <svg width="40" height="40">
                            <line x1="5" y1="20" x2="30" y2="20" stroke="#000" stroke-width="2"/>
                            <polygon points="30,20 25,17 25,23" fill="#000"/>
                        </svg>
                        <span>Sequence Flow</span>
                    </div>
                    </div>
                </div>

                <!-- Subprocess Definitions Panel -->
                <div class="palette-section subprocess-definitions-section">
                    <h4 style="display: flex; align-items: center; justify-content: space-between;">
                        <span>üìö Subprocess Definitions</span>
                        <button id="addSubProcessDefBtn" class="btn-icon" title="Create new subprocess definition">+</button>
                    </h4>
                    <div id="subProcessDefList" class="subprocess-def-list">
                        <p class="placeholder" style="font-size: 0.85rem; color: #999; padding: 0.5rem;">
                            No subprocess definitions.<br>
                            Click + to create one.
                        </p>
                    </div>
                </div>
            </aside>

            <main class="canvas-container">
                <div class="canvas-controls">
                    <button id="undoBtn" class="btn-small" title="Undo (Ctrl+Z)">‚Ü∂ Undo</button>
                    <button id="redoBtn" class="btn-small" title="Redo (Ctrl+Y)">‚Ü∑ Redo</button>
                    <span style="margin: 0 0.5rem; border-left: 1px solid #ccc;"></span>
                    <button id="addPoolBtn" class="btn-small">Add Pool</button>
                    <button id="zoomInBtn" class="btn-small" title="Zoom In (Mouse Wheel)">üîç+</button>
                    <button id="zoomOutBtn" class="btn-small" title="Zoom Out (Mouse Wheel)">üîç-</button>
                    <button id="resetZoomBtn" class="btn-small" title="Reset View">‚Ü∫ Reset</button>
                    <button id="fitToViewBtn" class="btn-small" title="Fit to View">‚õ∂ Fit</button>
                    <span style="margin: 0 0.5rem; color: #666; font-size: 0.85rem;" title="Shift+Drag or Middle-Click to Pan">‚úã Pan: Shift+Drag</span>
                    <button id="deleteBtn" class="btn-small btn-danger">Delete Selected</button>
                    <span style="margin: 0 0.5rem; border-left: 1px solid #ccc;"></span>
                    <div id="subprocessEditorIndicator" style="display: none; background: #3498db; color: white; padding: 0.3rem 0.8rem; border-radius: 4px; font-size: 0.85rem; font-weight: bold;">
                        üìù Editing Subprocess: <span id="subprocessEditorName"></span>
                        <button id="exitSubprocessEditorBtn" style="margin-left: 0.5rem; background: white; color: #3498db; border: none; padding: 0.2rem 0.5rem; border-radius: 3px; cursor: pointer; font-weight: bold;">‚úï Close</button>
                    </div>
                </div>
                <svg id="canvas" width="100%" height="100%">
                    <defs>
                        <marker id="arrowhead" markerWidth="10" markerHeight="10" refX="9" refY="3" orient="auto">
                            <polygon points="0 0, 10 3, 0 6" fill="#000" />
                        </marker>
                    </defs>
                    <g id="mainGroup" transform="scale(1)">
                        <g id="poolsLayer"></g>
                        <g id="connectionsLayer"></g>
                        <g id="elementsLayer"></g>
                    </g>
                </svg>
            </main>

            <aside class="properties-panel">
                <h3>Properties</h3>
                <div id="propertiesContent">
                    <p class="placeholder">Select an element to edit properties</p>
                </div>
            </aside>
        </div>

        <div id="yamlModal" class="modal">
            <div class="modal-content">
                <span class="close">&times;</span>
                <h2>YAML Export</h2>
                <textarea id="yamlOutput" rows="20"></textarea>
                <button id="copyYamlBtn" class="btn">Copy to Clipboard</button>
                <button id="downloadYamlBtn" class="btn">Download</button>
            </div>
        </div>

        <div id="executeModal" class="modal">
            <div class="modal-content">
                <span class="close">&times;</span>
                <h2>Execute Workflow</h2>

                <div class="execution-form">
                    <div class="form-group">
                        <label for="logFileInput">Upload Log File (Optional):</label>
                        <input type="file" id="logFileInput" accept=".log,.txt,*">
                        <p class="help-text">Upload a log file to analyze. The file will be read locally and passed to the workflow.</p>
                    </div>

                    <div class="form-group">
                        <label for="contextInput">Context Variables (JSON):</label>
                        <textarea id="contextInput" rows="10" placeholder='{\n  "requester": {\n    "email": "user@example.com",\n    "name": "Test User"\n  }\n}'></textarea>
                        <p class="help-text">Enter any additional context variables needed by the workflow.</p>
                    </div>

                    <div class="modal-actions">
                        <button id="startExecutionBtn" class="btn execute-workflow-btn">Start Execution</button>
                        <button id="cancelExecutionBtn" class="btn">Cancel</button>
                    </div>
                </div>
            </div>
        </div>

        <div id="simulateModal" class="modal">
            <div class="modal-content" style="max-width: 500px;">
                <span class="close">&times;</span>
                <h2>üé¨ Start Simulation</h2>

                <div class="simulation-info" style="background: #f0f8ff; padding: 1rem; border-radius: 4px; margin-bottom: 1rem;">
                    <p style="margin: 0; font-size: 0.9rem;">
                        <strong>Simulation Mode:</strong> Visualize token flow without executing actual tasks.
                        Controls will appear in the toolbar during playback.
                    </p>
                </div>

                <div class="execution-form">
                    <div class="form-group">
                        <label for="simulationSpeed">Simulation Speed:</label>
                        <select id="simulationSpeed" style="width: 100%; padding: 0.5rem; border: 1px solid #ccc; border-radius: 4px; font-size: 1rem;">
                            <option value="0.5">üêå 0.5x - Slow (presentations)</option>
                            <option value="1" selected>‚ñ∂Ô∏è 1x - Normal</option>
                            <option value="2">‚ö° 2x - Fast</option>
                            <option value="5">üöÄ 5x - Very Fast</option>
                            <option value="10">üí® 10x - Ultra Fast</option>
                        </select>
                        <p class="help-text">You can change speed during playback using the toolbar controls.</p>
                    </div>

                    <div class="modal-actions">
                        <button id="startSimulationBtn" class="btn" style="background-color: #9b59b6; color: white; font-size: 1rem; padding: 0.6rem 1.5rem;">üé¨ Start Simulation</button>
                        <button id="cancelSimulationBtn" class="btn">Cancel</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/js-yaml@4.1.0/dist/js-yaml.min.js"></script>
    <script src="agui-client.js"></script>
    <script src="app.js"></script>
    <script src="workflow-executor.js"></script>
    <script src="token-simulator.js"></script>
</body>
</html>
