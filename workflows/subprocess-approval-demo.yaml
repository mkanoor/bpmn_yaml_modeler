process:
  id: process_1
  name: Subprocess Approval Demo - Reusable Email Approval
  pools:
    - id: pool_1
      name: Workflow with Reusable Approval Subprocess
      x: 50
      y: 50
      width: 2400
      height: 800
      lanes:
        - id: lane_1
          name: Main Process Flow
          height: 300
        - id: lane_2
          name: Approval Subprocess (Reusable)
          height: 250
        - id: lane_3
          name: Execution
          height: 250

  elements:
    # ===== MAIN PROCESS FLOW =====

    # Start Event
    - id: element_1
      type: startEvent
      name: Start Process
      x: 120
      y: 150
      poolId: pool_1
      laneId: lane_1
      properties:
        documentation: "Workflow demonstrates subprocess reuse in two places"

    # Task 1 - Initial Processing
    - id: element_2
      type: scriptTask
      name: Initial Processing
      x: 250
      y: 150
      poolId: pool_1
      laneId: lane_1
      properties:
        scriptFormat: "Python"
        resultVariable: "processData"
        documentation: "First task that needs approval"
        script: |
          print('Processing initial data...')
          result = {
              'task': 'Initial Processing',
              'data': 'Some important data',
              'requiresApproval': True
          }

    # ===== SUBPROCESS 1 - FIRST USE OF APPROVAL SUBPROCESS =====

    # Call Activity 1 - Email Approval Subprocess (First Use)
    - id: element_3
      type: subProcess
      name: Email Approval Subprocess
      x: 420
      y: 150
      poolId: pool_1
      laneId: lane_1
      expanded: true
      width: 450
      height: 150
      properties:
        documentation: "Reusable subprocess: Send email with approval links and wait for webhook response"
      childElements:
        # Subprocess Start
        - id: sp1_start
          type: startEvent
          name: Start
          x: -180
          y: 0
          properties: {}

        # Send Email with Approval Links
        - id: sp1_send
          type: sendTask
          name: Send Approval Email
          x: -80
          y: 0
          properties:
            messageType: "Email"
            to: ""
            subject: "Approval Required: ${taskName}"
            messageBody: |
              Please review and approve the following request.

              Task: ${taskName}
              Details: ${taskDetails}

              Click below to approve or deny:
            useGmail: true
            htmlFormat: true
            includeApprovalLinks: true
            approvalMessageRef: "approvalRequest"
            approvalCorrelationKey: "${workflowInstanceId}-${taskId}"
            documentation: "Send email with approve/deny webhook links"

        # Wait for Webhook Response
        - id: sp1_receive
          type: receiveTask
          name: Await Response
          x: 80
          y: 0
          properties:
            messageRef: "approvalRequest"
            correlationKey: "${workflowInstanceId}-${taskId}"
            timeout: "3600000"
            useWebhook: true
            documentation: "Wait for approval/denial via email webhook (1 hour timeout)"

        # Subprocess End
        - id: sp1_end
          type: endEvent
          name: End
          x: 180
          y: 0
          properties: {}

      childConnections:
        - id: sp1_conn1
          from: sp1_start
          to: sp1_send
          type: sequenceFlow
          name: ""
          properties: {}

        - id: sp1_conn2
          from: sp1_send
          to: sp1_receive
          type: sequenceFlow
          name: ""
          properties: {}

        - id: sp1_conn3
          from: sp1_receive
          to: sp1_end
          type: sequenceFlow
          name: ""
          properties: {}

    # Gateway - Check First Approval
    - id: element_4
      type: exclusiveGateway
      name: Approved?
      x: 920
      y: 150
      poolId: pool_1
      laneId: lane_1
      properties:
        documentation: "Check if first approval was granted"

    # Task 2 - Second Processing (only if first approved)
    - id: element_5
      type: scriptTask
      name: Second Processing
      x: 1080
      y: 150
      poolId: pool_1
      laneId: lane_1
      properties:
        scriptFormat: "Python"
        resultVariable: "secondProcessData"
        documentation: "Second task that also needs approval"
        script: |
          print('Processing second stage...')
          result = {
              'task': 'Second Processing',
              'data': 'More critical data',
              'requiresApproval': True
          }

    # ===== SUBPROCESS 2 - SECOND USE OF APPROVAL SUBPROCESS (SAME SUBPROCESS) =====

    # Call Activity 2 - Email Approval Subprocess (Second Use - REUSED!)
    - id: element_6
      type: subProcess
      name: Email Approval Subprocess
      x: 1250
      y: 150
      poolId: pool_1
      laneId: lane_1
      expanded: true
      width: 450
      height: 150
      properties:
        documentation: "SAME subprocess reused for second approval - demonstrates reusability"
      childElements:
        # Subprocess Start
        - id: sp2_start
          type: startEvent
          name: Start
          x: -180
          y: 0
          properties: {}

        # Send Email with Approval Links
        - id: sp2_send
          type: sendTask
          name: Send Approval Email
          x: -80
          y: 0
          properties:
            messageType: "Email"
            to: ""
            subject: "Approval Required: ${taskName}"
            messageBody: |
              Please review and approve the following request.

              Task: ${taskName}
              Details: ${taskDetails}

              Click below to approve or deny:
            useGmail: true
            htmlFormat: true
            includeApprovalLinks: true
            approvalMessageRef: "approvalRequest"
            approvalCorrelationKey: "${workflowInstanceId}-${taskId}"
            documentation: "Send email with approve/deny webhook links"

        # Wait for Webhook Response
        - id: sp2_receive
          type: receiveTask
          name: Await Response
          x: 80
          y: 0
          properties:
            messageRef: "approvalRequest"
            correlationKey: "${workflowInstanceId}-${taskId}"
            timeout: "3600000"
            useWebhook: true
            documentation: "Wait for approval/denial via email webhook (1 hour timeout)"

        # Subprocess End
        - id: sp2_end
          type: endEvent
          name: End
          x: 180
          y: 0
          properties: {}

      childConnections:
        - id: sp2_conn1
          from: sp2_start
          to: sp2_send
          type: sequenceFlow
          name: ""
          properties: {}

        - id: sp2_conn2
          from: sp2_send
          to: sp2_receive
          type: sequenceFlow
          name: ""
          properties: {}

        - id: sp2_conn3
          from: sp2_receive
          to: sp2_end
          type: sequenceFlow
          name: ""
          properties: {}

    # Gateway - Check Second Approval
    - id: element_7
      type: exclusiveGateway
      name: Approved?
      x: 1750
      y: 150
      poolId: pool_1
      laneId: lane_1
      properties:
        documentation: "Check if second approval was granted"

    # ===== EXECUTION LANE =====

    # Final Execution
    - id: element_8
      type: scriptTask
      name: Execute Approved Actions
      x: 1910
      y: 550
      poolId: pool_1
      laneId: lane_3
      properties:
        scriptFormat: "Python"
        resultVariable: "executionResult"
        documentation: "Execute actions after both approvals granted"
        script: |
          print('Executing approved actions...')
          print('First approval: ' + str(context.get('decision')))
          print('Second approval: ' + str(context.get('decision')))
          result = {
              'status': 'success',
              'message': 'Both approvals granted, actions executed'
          }

    # Success End
    - id: element_9
      type: endEvent
      name: Success
      x: 2150
      y: 550
      poolId: pool_1
      laneId: lane_3
      properties:
        documentation: "Both approvals granted, workflow complete"

    # ===== ERROR PATHS =====

    # First Rejection Notification
    - id: element_10
      type: sendTask
      name: Notify First Rejection
      x: 920
      y: 350
      poolId: pool_1
      laneId: lane_1
      properties:
        messageType: "Email"
        to: ""
        subject: "Request Denied - First Approval"
        messageBody: "The first approval request was denied. Workflow terminated."
        documentation: "Notify of first rejection"

    # First Rejection End
    - id: element_11
      type: endEvent
      name: Rejected (First)
      x: 1080
      y: 350
      poolId: pool_1
      laneId: lane_1
      properties:
        documentation: "First approval rejected"

    # Second Rejection Notification
    - id: element_12
      type: sendTask
      name: Notify Second Rejection
      x: 1750
      y: 350
      poolId: pool_1
      laneId: lane_1
      properties:
        messageType: "Email"
        to: ""
        subject: "Request Denied - Second Approval"
        messageBody: "The second approval request was denied. Workflow terminated."
        documentation: "Notify of second rejection"

    # Second Rejection End
    - id: element_13
      type: endEvent
      name: Rejected (Second)
      x: 1910
      y: 350
      poolId: pool_1
      laneId: lane_1
      properties:
        documentation: "Second approval rejected"

  connections:
    # Main happy path
    - id: conn_1
      type: sequenceFlow
      name: ""
      from: element_1
      to: element_2

    - id: conn_2
      type: sequenceFlow
      name: "needs approval"
      from: element_2
      to: element_3

    - id: conn_3
      type: sequenceFlow
      name: ""
      from: element_3
      to: element_4

    # First approval decision
    - id: conn_4
      type: sequenceFlow
      name: "approved"
      from: element_4
      to: element_5
      properties:
        condition: ""

    - id: conn_5
      type: sequenceFlow
      name: "rejected"
      from: element_4
      to: element_10
      properties:
        condition: "${decision} == 'rejected'"

    - id: conn_6
      type: sequenceFlow
      name: ""
      from: element_10
      to: element_11

    # Second approval flow
    - id: conn_7
      type: sequenceFlow
      name: "needs approval"
      from: element_5
      to: element_6

    - id: conn_8
      type: sequenceFlow
      name: ""
      from: element_6
      to: element_7

    # Second approval decision
    - id: conn_9
      type: sequenceFlow
      name: "approved"
      from: element_7
      to: element_8
      properties:
        condition: ""

    - id: conn_10
      type: sequenceFlow
      name: "rejected"
      from: element_7
      to: element_12
      properties:
        condition: "${decision} == 'rejected'"

    - id: conn_11
      type: sequenceFlow
      name: ""
      from: element_12
      to: element_13

    # Final execution
    - id: conn_12
      type: sequenceFlow
      name: ""
      from: element_8
      to: element_9
