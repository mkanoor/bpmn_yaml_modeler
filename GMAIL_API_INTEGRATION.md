# Gmail API Integration for Send Tasks

## Overview

The BPMN Workflow Executor now supports sending real emails via Gmail API. This allows send tasks to deliver actual email notifications instead of just simulating email delivery.

## Features

- **OAuth 2.0 Authentication** - Secure authentication using Google OAuth
- **Real Email Sending** - Send actual emails through your Gmail account
- **HTML Support** - Send rich HTML-formatted emails
- **Variable Substitution** - Dynamic content using `${variable}` syntax
- **Fallback Mode** - Automatic fallback to simulation if Gmail not configured

## Setup Instructions

### Step 1: Create Google Cloud Project

1. Go to [Google Cloud Console](https://console.cloud.google.com/)
2. Click **"Create Project"** or select existing project
3. Give your project a name (e.g., "BPMN Workflow Executor")
4. Click **"Create"**

### Step 2: Enable Gmail API

1. In Google Cloud Console, go to **"APIs & Services"** ‚Üí **"Library"**
2. Search for **"Gmail API"**
3. Click on **"Gmail API"**
4. Click **"Enable"**

### Step 3: Create OAuth Credentials

1. Go to **"APIs & Services"** ‚Üí **"Credentials"**
2. Click **"Create Credentials"** ‚Üí **"OAuth client ID"**
3. If prompted, configure the **OAuth consent screen**:
   - Choose **"External"** user type (or Internal if G Suite)
   - Fill in required fields:
     - App name: `BPMN Workflow Executor`
     - User support email: Your email
     - Developer contact: Your email
   - Click **"Save and Continue"**
   - Add scopes: Click **"Add or Remove Scopes"**
     - Search for Gmail API
     - Select: `https://www.googleapis.com/auth/gmail.send`
   - Click **"Save and Continue"**
   - Add test users (your email address)
   - Click **"Save and Continue"**

4. Back in Credentials, click **"Create Credentials"** ‚Üí **"OAuth client ID"**
5. Choose **"Desktop app"** as application type
6. Name it: `BPMN Executor Desktop Client`
7. Click **"Create"**

### Step 4: Download Credentials

1. You'll see a popup with your Client ID and Secret
2. Click **"Download JSON"**
3. Save the file as `credentials.json` in your backend directory:
   ```
   /Users/madhukanoor/devsrc/bpmn/backend/credentials.json
   ```

**IMPORTANT:** Never commit `credentials.json` to version control!

### Step 5: First-Time Authentication

1. Start your backend server:
   ```bash
   cd backend
   python main.py
   ```

2. Execute a workflow with a send task that has **"Use Gmail API"** enabled

3. On first run, a browser window will open asking you to:
   - Choose your Google account
   - Click **"Continue"** (it may show "Google hasn't verified this app" - this is normal for development)
   - Click **"Advanced"** ‚Üí **"Go to BPMN Workflow Executor (unsafe)"**
   - Grant permission to send emails
   - Click **"Allow"**

4. After authentication, a `token.json` file will be created automatically:
   ```
   /Users/madhukanoor/devsrc/bpmn/backend/token.json
   ```

5. Subsequent runs will use this token automatically (no browser popup needed)

**Token Refresh:** The token is automatically refreshed when it expires.

## Using Gmail in Send Tasks

### Configure Send Task Properties

When creating/editing a send task:

1. **Message Type:** Select `Email`
2. **To:** Recipient email (e.g., `user@example.com`)
3. **Subject:** Email subject (supports variables: `${sum} Calculation Result`)
4. **Message Body:** Email content (supports variables)
5. **‚úÖ Use Gmail API:** Check this box to enable Gmail sending
6. **From Email (optional):** Sender email (uses authenticated account if blank)
7. **‚úÖ HTML Format:** Check if message body contains HTML

### Example Send Task Configuration

**Success Notification:**
```yaml
properties:
  messageType: Email
  to: admin@example.com
  subject: Workflow Success - Sum = ${sum}
  messageBody: |
    The workflow completed successfully!

    Results:
    - Sum: ${sum}
    - Status: Success

    Workflow execution complete.
  useGmail: true
  htmlFormat: false
```

**HTML Email:**
```yaml
properties:
  messageType: Email
  to: team@example.com
  subject: Daily Report
  messageBody: |
    <html>
    <body>
      <h2>Daily Workflow Report</h2>
      <p>Total items processed: <strong>${itemCount}</strong></p>
      <p>Status: <span style="color: green;">‚úì Success</span></p>
      <hr>
      <small>Generated by BPMN Workflow Executor</small>
    </body>
    </html>
  useGmail: true
  htmlFormat: true
```

## File Structure

```
backend/
‚îú‚îÄ‚îÄ credentials.json       # OAuth credentials (from Google Cloud Console)
‚îú‚îÄ‚îÄ token.json            # Auto-generated OAuth token (after first auth)
‚îú‚îÄ‚îÄ gmail_service.py      # Gmail API service module
‚îú‚îÄ‚îÄ task_executors.py     # Modified SendTaskExecutor with Gmail support
‚îî‚îÄ‚îÄ requirements.txt      # Updated with Gmail API dependencies
```

## Environment Variables (Optional)

You can customize file paths using environment variables:

```bash
# .env file
GMAIL_CREDENTIALS_FILE=/path/to/credentials.json
GMAIL_TOKEN_FILE=/path/to/token.json
```

Default paths:
- `credentials.json` (in backend directory)
- `token.json` (in backend directory)

## Behavior

### When Gmail is Enabled (`useGmail: true`)

1. **Credentials Found:**
   - Authenticates using OAuth (browser opens on first run)
   - Sends real email via Gmail API
   - Returns message ID from Gmail
   - Backend logs: `"Sent Email via Gmail - Subject: ..."`

2. **Credentials Missing:**
   - Raises exception: `"Gmail not configured. Please add credentials.json file."`
   - Workflow fails with error message
   - User can see error in UI

### When Gmail is Disabled (`useGmail: false`)

- Simulates email sending (default behavior)
- Logs: `"Sent Email (simulated) - Subject: ..."`
- No actual email sent
- Useful for testing workflows

## Security Best Practices

1. **Never Commit Secrets:**
   ```bash
   # Add to .gitignore
   backend/credentials.json
   backend/token.json
   ```

2. **Use Test Account:** Use a dedicated Gmail account for workflow automation, not your personal account

3. **Restrict Scopes:** Only grant `gmail.send` scope (read access not needed)

4. **Test Users:** Add specific test users in OAuth consent screen during development

5. **Review Permissions:** Periodically review apps connected to your Google account:
   - https://myaccount.google.com/permissions

## Troubleshooting

### Error: "Gmail authentication failed"

**Cause:** Missing or invalid credentials file

**Fix:**
1. Check that `credentials.json` exists in backend directory
2. Verify file is valid JSON (download again from Google Cloud Console)
3. Ensure Gmail API is enabled in your project

### Error: "Invalid grant" or "Token expired"

**Cause:** OAuth token is invalid or corrupted

**Fix:**
1. Delete `token.json` file
2. Restart backend
3. Re-authenticate when browser opens

### Browser doesn't open for authentication

**Cause:** Running on headless server or SSH session

**Fix:**
- Run backend on machine with desktop/browser
- Or use service account credentials (advanced)

### Error: "Gmail API has not been used in project XXX"

**Cause:** Gmail API not enabled

**Fix:**
1. Go to Google Cloud Console
2. Enable Gmail API for your project
3. Wait 1-2 minutes for propagation

### Emails not arriving

**Check:**
1. Verify recipient email is correct
2. Check spam folder
3. Review Gmail "Sent" folder in authenticated account
4. Check backend logs for message ID
5. Verify Gmail API quota not exceeded (default: 1 billion requests/day)

## Backend Logs

When Gmail sending is successful, you'll see:

```
INFO - Executing send task: Send Success Notification
INFO - Sending Email via Gmail API
INFO - Email sent successfully. Message ID: 18d1234567890abc
INFO - Sent Email via Gmail - Subject: Sum Calculation Success, Message ID: 18d1234567890abc
INFO - Task completed: Send Success Notification
```

When simulating (Gmail disabled):

```
INFO - Executing send task: Send Success Notification
INFO - Sent Email (simulated) - Subject: Sum Calculation Success
INFO - Task completed: Send Success Notification
```

## API Rate Limits

**Gmail API Quotas (Free Tier):**
- **Send requests:** 1 billion/day
- **Messages sent:** 500/day per user (standard Gmail account)
- **Requests per minute:** 250

**Google Workspace accounts have higher limits.**

## Testing Checklist

- [ ] Create Google Cloud project
- [ ] Enable Gmail API
- [ ] Create OAuth credentials
- [ ] Download `credentials.json` to backend directory
- [ ] Start backend server
- [ ] Create workflow with send task
- [ ] Enable "Use Gmail API" checkbox
- [ ] Execute workflow
- [ ] Complete OAuth authentication in browser
- [ ] Verify email received
- [ ] Check backend logs for message ID
- [ ] Test HTML email (enable "HTML Format")
- [ ] Test variable substitution in subject/body
- [ ] Verify `token.json` created for future runs

## Example Workflow YAML

```yaml
process:
  name: Gmail Notification Example
  id: gmail-notification-example
  elements:
    - id: element_1
      type: startEvent
      name: Start
      x: 100
      y: 150

    - id: element_2
      type: sendTask
      name: Send Email via Gmail
      x: 300
      y: 150
      properties:
        messageType: Email
        to: recipient@example.com
        subject: Test Email from BPMN Executor
        messageBody: |
          Hello!

          This is a test email sent via Gmail API.

          Timestamp: ${timestamp}
        useGmail: true
        fromEmail: sender@gmail.com
        htmlFormat: false

    - id: element_3
      type: endEvent
      name: End
      x: 500
      y: 150

  connections:
    - id: conn_1
      type: sequenceFlow
      from: element_1
      to: element_2

    - id: conn_2
      type: sequenceFlow
      from: element_2
      to: element_3
```

## Dependencies

Added to `backend/requirements.txt`:

```
google-api-python-client==2.111.0
google-auth==2.25.2
google-auth-oauthlib==1.2.0
google-auth-httplib2==0.2.0
```

Install with:
```bash
cd backend
pip install -r requirements.txt
```

## Summary

**Gmail API integration allows your workflows to send real emails!**

| Feature | Simulated | Gmail API |
|---------|-----------|-----------|
| Email sent | ‚ùå No | ‚úÖ Yes |
| Setup required | None | OAuth credentials |
| Backend logs | "simulated" | Message ID |
| HTML support | ‚ùå | ‚úÖ |
| Variable substitution | ‚úÖ | ‚úÖ |
| Rate limits | None | 500/day |

**Ready to send real emails? Follow the setup steps above!** üìß
